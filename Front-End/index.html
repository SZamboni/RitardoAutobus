<!DOCTYPE html>
<html>
   <head>
      <title> Where is my bus Login </title>
      <meta charset="utf-8">
      <meta name="google-signin-scope" content="profile">
      <meta name="google-signin-client_id" content="357283213666-8s2b8eiguf5abidvemu4f39aucupgggk.apps.googleusercontent.com">
      <script src="https://apis.google.com/js/platform.js" async defer></script>
   </head>

   <body>

        <div class="g-signin2" data-onsuccess="onSignIn" data-theme="dark"></div>
        
        <script>
          /**
           * Script javascript che contiene la funzione di login in Google 
           * 
           * @author Simone Zamboni
           * @date 2017-10-30
           */

           var serverLocation = "http://localhost:8080";  // variable that store the location of the server

          /**
           * Function that is callen on a successful Google Login
           */
          function onSignIn(googleUser) {

            var profile = googleUser.getBasicProfile();   // get the profile that has signed in

            /* // display the information about the user
            console.log("ID: " + profile.getId());
            console.log('Full Name: ' + profile.getName());
            console.log('Given Name: ' + profile.getGivenName());
            console.log('Family Name: ' + profile.getFamilyName());
            console.log("Image URL: " + profile.getImageUrl());
            console.log("Email: " + profile.getEmail()); */
    
            // The ID token you need to pass to your backend:
            var id_token = "" + googleUser.getAuthResponse().id_token;

            // set the cookie to the user
            document.cookie = "email=" + profile.getEmail();
            document.cookie = "token=" + id_token;

            // information that will be sendt to the server
            var informations = {
                'id_token' : id_token,
                'id' : profile.getId(),
                'email' : profile.getEmail(),
                'image_url' : profile.getImageUrl()
            }
            console.log("Information that will be sent:\n " + JSON.stringify(informations));

            // sending the information using a XMLHTTPRequest
            var post_url = serverLocation + "/postlogin";

            // fetch the url
            fetch(post_url, {
              method: "POST",   // this is a HTTP POST
              headers: {
                'Content-Type': 'application/json'    // the content is a JSON so we must set the Content-Type header
              },

              // body to send in the request, must convert in string before sending
              body: JSON.stringify(informations)
            })
            .then( (response) => { // function executed when the request is finisced
              //  Redirect the user to the new page
              var newUrl = serverLocation + "/bus-visualization";
              document.location.href = newUrl; 
            });            

          };
        </script>

        <a href="#" onclick="signOut();">Sign out</a>
        <script>
          // the sign out button
          function signOut() {
              var auth2 = gapi.auth2.getAuthInstance();
              auth2.signOut().then(function () {
              console.log('User signed out.');
              });
          }
        </script>
      
   </body>
</html>